"""
üì± Discord Comment Notifier V2 - Design Minimaliste et Moderne
==============================================================

Nouvelle approche pour les notifications de commentaires Discord :
- Design √©pur√© et minimaliste
- Informations essentielles uniquement  
- Code couleur intuitif
- Format compact et moderne

Version: 4.2.0
Date: Ao√ªt 2025
"""

import logging
from typing import Dict, Any, Optional
from datetime import datetime
import requests

logger = logging.getLogger(__name__)

class ModernCommentNotifier:
    """Notificateur Discord moderne pour les commentaires Frame.io"""
    
    def __init__(self, webhook_url: str, bot_name: str = "PostFlow", share_manager=None):
        self.webhook_url = webhook_url
        self.bot_name = bot_name
        # Avatar URL valide pour Discord (ou None pour utiliser l'avatar par d√©faut)
        self.avatar_url = "https://cdn.discordapp.com/embed/avatars/0.png"
        self.share_manager = share_manager  # Gestionnaire Frame.io shares
    
    def send_comment_notification(self, 
                                shot_name: str,
                                commenter: str, 
                                comment_text: str,
                                review_status: str = "NEED_REVIEW",
                                frameio_link: Optional[str] = None,
                                timecode: Optional[str] = None,
                                file_id: Optional[str] = None) -> bool:
        """
        Envoie une notification de commentaire avec design minimaliste
        
        Args:
            shot_name: Nom du plan (ex: "UNDLM_00146")
            commenter: Nom du commentateur
            comment_text: Texte du commentaire
            review_status: Statut automatiquement d√©tect√©
            frameio_link: Lien Frame.io (sera remplac√© par share link si possible)
            timecode: Timecode optionnel
            file_id: ID du fichier Frame.io pour cr√©er un share link
        """
        try:
            # D√©terminer l'√©moji et couleur selon le statut
            status_config = self._get_status_config(review_status)
            
            # Nettoyer et formater le nom du commentateur
            clean_commenter = self._format_commenter_name(commenter)
            
            # Cr√©er un lien de partage si possible
            share_link = self._get_or_create_share_link(file_id, shot_name)
            final_link = share_link or frameio_link
            
            # Format minimaliste : une seule ligne principale
            main_message = f"{status_config['emoji']} **{shot_name}** ¬∑ {clean_commenter}"
            
            # Embed ultra-compact
            embed = {
                "description": f"üí¨ {comment_text[:150]}{'...' if len(comment_text) > 150 else ''}",
                "color": status_config['color']
            }
            
            # Ajouter footer discret avec infos secondaires
            footer_parts = []
            if timecode:
                footer_parts.append(f"‚è±Ô∏è {timecode}")
            if final_link:
                if share_link:
                    footer_parts.append("üîó Partage Frame.io")  # Indiquer que c'est un lien de partage
                else:
                    footer_parts.append("üì∫ Frame.io")  # Lien classique
            
            if footer_parts:
                embed["footer"] = {
                    "text": " ‚Ä¢ ".join(footer_parts)
                }
            
            # Timestamp moderne
            embed["timestamp"] = datetime.now().isoformat()
            
            return self._send_to_discord(main_message, embed, final_link)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur notification commentaire moderne: {e}")
            return False
    
    def send_batch_comments_summary(self, comments_data: Dict[str, Any]) -> bool:
        """
        Notification group√©e pour plusieurs commentaires (design compact)
        """
        try:
            shot_name = comments_data.get('shot_name', 'Plan inconnu')
            comments_count = comments_data.get('count', 0)
            latest_status = comments_data.get('latest_status', 'NEED_REVIEW')
            
            status_config = self._get_status_config(latest_status)
            
            main_message = f"{status_config['emoji']} **{shot_name}** ¬∑ {comments_count} nouveaux commentaires"
            
            embed = {
                "description": f"üìä {comments_count} commentaires re√ßus",
                "color": status_config['color'],
                "footer": {
                    "text": f"Statut: {latest_status} ‚Ä¢ Frame.io"
                },
                "timestamp": datetime.now().isoformat()
            }
            
            return self._send_to_discord(main_message, embed)
            
        except Exception as e:
            logger.error(f"‚ùå Erreur notification group√©e: {e}")
            return False
    
    def _get_status_config(self, status: str) -> Dict[str, Any]:
        """Configuration moderne des statuts avec √©mojis et couleurs"""
        configs = {
            'APPROVED': {
                'emoji': '‚úÖ',
                'color': 0x00D26A,  # Vert Discord moderne
                'label': 'Approuv√©'
            },
            'NEED_REWORK': {
                'emoji': 'üîÑ',
                'color': 0xFAA61A,  # Orange Discord moderne  
                'label': '√Ä r√©viser'
            },
            'REJECTED': {
                'emoji': '‚ùå',
                'color': 0xED4245,  # Rouge Discord moderne
                'label': 'Rejet√©'
            },
            'NEED_REVIEW': {
                'emoji': '‚è≥',
                'color': 0x5865F2,  # Bleu Discord moderne (blurple)
                'label': 'En attente'
            }
        }
        return configs.get(status, configs['NEED_REVIEW'])
    
    def _format_commenter_name(self, commenter: str) -> str:
        """Formate et nettoie le nom du commentateur pour un affichage optimal"""
        
        # Debug logging
        logger.debug(f"üîç Formatage nom d'origine: '{commenter}' (type: {type(commenter)})")
        
        if not commenter or commenter.strip() == "":
            logger.warning("‚ö†Ô∏è Nom commentateur vide, utilisation fallback 'Utilisateur'")
            return "Utilisateur"
        
        # Nettoyer le nom (supprimer espaces suppl√©mentaires)
        clean_name = commenter.strip()
        
        # Cas sp√©ciaux Frame.io
        if clean_name in ['Frame.io User', 'Inconnu', 'Unknown', 'None']:
            logger.warning(f"‚ö†Ô∏è Nom g√©n√©rique d√©tect√©: '{clean_name}', utilisation fallback")
            return "Utilisateur"
        
        # Si c'est un email, extraire juste le nom avant @
        if "@" in clean_name:
            clean_name = clean_name.split("@")[0]
            # Remplacer les points par des espaces pour les emails
            clean_name = clean_name.replace(".", " ")
        
        # V√©rifier si le nom est vide apr√®s nettoyage
        if not clean_name or clean_name.strip() == "":
            logger.warning("‚ö†Ô∏è Nom vide apr√®s nettoyage, utilisation fallback")
            return "Utilisateur"
        
        # Limiter la longueur pour √©viter les noms trop longs dans Discord
        if len(clean_name) > 25:
            clean_name = clean_name[:22] + "..."
        
        # Capitaliser intelligemment en pr√©servant les caract√®res sp√©ciaux
        # S√©parer sur les espaces et tirets
        parts = []
        for part in clean_name.split():
            # Traiter chaque partie en pr√©servant les tirets et apostrophes
            subparts = []
            for subpart in part.replace("-", " - ").replace("'", " ' ").split():
                if subpart in ["-", "'"]:
                    subparts.append(subpart)
                elif len(subpart) > 0:
                    subparts.append(subpart.capitalize())
            parts.append("".join(subparts))
        
        formatted_name = " ".join(parts)
        
        # Debug du r√©sultat
        logger.debug(f"‚úÖ Nom format√©: '{commenter}' ‚Üí '{formatted_name}'")
        
        return formatted_name
    
    def _get_or_create_share_link(self, file_id: Optional[str], shot_name: str) -> Optional[str]:
        """
        R√©cup√®re ou cr√©e un lien de partage Frame.io pour le fichier
        
        Args:
            file_id: ID du fichier Frame.io
            shot_name: Nom du shot pour nommer le partage
            
        Returns:
            URL du lien de partage ou None si impossible
        """
        if not file_id or not self.share_manager:
            logger.debug("üîó Pas de file_id ou share_manager disponible")
            return None
        
        try:
            # Cr√©er un lien de partage pour ce fichier
            share_url = self.share_manager.create_share_for_shot(
                file_id=file_id,
                shot_name=shot_name,
                expires_in_days=30  # Lien valide 30 jours
            )
            
            if share_url:
                logger.info(f"üîó Lien de partage cr√©√© pour {shot_name}: {share_url[:50]}...")
                return share_url
            else:
                logger.warning(f"‚ö†Ô∏è Impossible de cr√©er un lien de partage pour {shot_name}")
                return None
                
        except Exception as e:
            logger.error(f"‚ùå Erreur cr√©ation lien de partage pour {shot_name}: {e}")
            return None
    
    def _send_to_discord(self, message: str, embed: Dict[str, Any], 
                        action_url: Optional[str] = None) -> bool:
        """Envoi vers Discord avec payload optimis√©"""
        try:
            payload = {
                "content": message,
                "username": self.bot_name,
                "embeds": [embed]
            }
            
            # Ajouter bouton d'action si lien Frame.io disponible
            if action_url:
                embed["url"] = action_url
            
            response = requests.post(self.webhook_url, json=payload, timeout=10)
            response.raise_for_status()
            
            logger.info(f"üì± Notification moderne envoy√©e: {message[:50]}...")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå √âchec envoi Discord: {e}")
            return False


# =============================================================================
# COMPARAISON : ANCIEN VS NOUVEAU FORMAT
# =============================================================================

def demo_comparison():
    """D√©monstration de la diff√©rence entre ancien et nouveau format"""
    
    print("üì± COMPARAISON DES FORMATS DISCORD")
    print("=" * 60)
    
    # Donn√©es d'exemple
    shot_name = "UNDLM_00146"
    commenter = "Antoine R√©alisateur"
    comment_text = "Super boulot sur cette s√©quence ! Juste un petit ajustement sur la colorim√©trie des ombres vers 00:12. Le mouvement de cam√©ra est parfait."
    review_status = "NEED_REWORK"
    
    print("\nüü• ANCIEN FORMAT (Verbeux):")
    print("-" * 30)
    old_format = f"""
üí¨ **Nouveau commentaire de review**

üìã Shot UNDLM_00146 - Version 1
üë§ Commentaire de Antoine R√©alisateur

**Commentaire:**
{comment_text}

**Timecode:** 00:12
**Frame.io:** [üì∫ Voir sur Frame.io](https://app.frame.io/...)
**Statut d√©tect√©:** NEED_REWORK - Modifications requises
**Timestamp:** Frame.io Review ‚Ä¢ Antoine R√©alisateur
"""
    print(old_format)
    
    print("\nüü¢ NOUVEAU FORMAT (Minimaliste):")
    print("-" * 30)
    new_format = f"""
üîÑ **{shot_name}** ¬∑ {commenter}

üí¨ {comment_text[:80]}...

‚è±Ô∏è 00:12 ‚Ä¢ üì∫ Frame.io
"""
    print(new_format)
    
    print("\nüìä ANALYSE:")
    print("- R√©duction de ~70% du texte")
    print("- Information essentielle pr√©serv√©e") 
    print("- Design plus moderne et √©pur√©")
    print("- Lecture plus rapide")
    print("- Couleurs Discord natives")


# =============================================================================
# TEMPLATES PR√äTS √Ä L'EMPLOI
# =============================================================================

MODERN_TEMPLATES = {
    'single_comment': {
        'message': "{emoji} **{shot_name}** ¬∑ {commenter}",
        'embed': {
            'description': "üí¨ {comment_text}",
            'color': "{status_color}",
            'footer': {'text': "{timecode} ‚Ä¢ üì∫ Frame.io"},
            'timestamp': "{timestamp}"
        }
    },
    
    'batch_comments': {
        'message': "{emoji} **{shot_name}** ¬∑ {count} commentaires",
        'embed': {
            'description': "üìä {count} nouveaux commentaires",
            'color': "{status_color}",
            'footer': {'text': "Statut: {status} ‚Ä¢ Frame.io"}
        }
    },
    
    'status_change': {
        'message': "{emoji} **{shot_name}** ‚Üí {new_status}",
        'embed': {
            'description': "üîÑ Statut mis √† jour automatiquement",
            'color': "{status_color}",
            'footer': {'text': "IA PostFlow"}
        }
    }
}


if __name__ == "__main__":
    # D√©monstration
    demo_comparison()
