#!/usr/bin/env python3
"""
Test complet du workflow PostFlow avec un vrai fichier
De LucidLink √† Frame.io avec notifications Discord
"""

import os
import sys
import json
import time
import shutil
from pathlib import Path
from datetime import datetime

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from src.integrations.review_workflow import ReviewWorkflowManager
from src.integrations.discord import DiscordNotifier, DiscordConfig
from src.integrations.frameio import FrameIOClient
from src.integrations.lucidlink import LucidLinkIntegration

def create_test_file():
    """Cr√©er un fichier de test pour simuler un export LucidLink"""
    print("üé¨ Cr√©ation du fichier de test")
    print("-" * 30)
    
    # Cr√©er dans le r√©pertoire temp
    temp_dir = Path(__file__).parent.parent / "temp"
    temp_dir.mkdir(exist_ok=True)
    
    test_file = temp_dir / "UNDLM_00001_v999_test.mov"
    
    try:
        # Cr√©er un fichier vid√©o de test avec FFmpeg si disponible
        import subprocess
        
        print("üé• Tentative cr√©ation vid√©o de test avec FFmpeg...")
        subprocess.run([
            'ffmpeg', '-f', 'lavfi', '-i', 'color=blue:size=64x64:duration=3',
            '-c:v', 'libx264', '-preset', 'ultrafast', '-crf', '30',
            '-t', '3', '-y', str(test_file)
        ], check=True, capture_output=True)
        
        print(f"‚úÖ Fichier vid√©o cr√©√©: {test_file}")
        print(f"   ‚Ä¢ Taille: {test_file.stat().st_size} bytes")
        return test_file
        
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("‚ö†Ô∏è  FFmpeg non disponible, cr√©ation fichier texte simul√©")
        
        # Cr√©er un fichier texte plus gros pour simuler
        with open(test_file, 'w') as f:
            f.write("# PostFlow Test File - Real Upload Test\n")
            f.write(f"# Created at: {datetime.now().isoformat()}\n")
            f.write("# This simulates a video export from LucidLink\n")
            f.write("# File: UNDLM_00001_v999_test.mov\n")
            f.write("# Scene: REVEIL HOPITAL - JOUR\n")
            f.write("# Version: v999\n")
            f.write("# Test: Real Frame.io Upload\n")
            f.write("\n")
            
            # Ajouter du contenu pour simuler un vrai fichier
            for i in range(100):
                f.write(f"# Frame {i:03d}: Test content line for PostFlow workflow\n")
                f.write(f"# Timestamp: {datetime.now().timestamp()}\n")
                f.write(f"# Data: {'X' * 50}\n")
                f.write("\n")
        
        print(f"‚úÖ Fichier texte cr√©√©: {test_file}")
        print(f"   ‚Ä¢ Taille: {test_file.stat().st_size} bytes")
        return test_file

def test_frameio_real_upload(test_file):
    """Test d'upload r√©el sur Frame.io"""
    print("\nüì§ Test Frame.io Upload R√âEL")
    print("-" * 30)
    
    try:
        # Load configuration
        frameio_config_path = Path(__file__).parent.parent / "config" / "frameio_config.json"
        with open(frameio_config_path, 'r') as f:
            frameio_config = json.load(f)
        
        # Initialize Frame.io client
        frameio_client = FrameIOClient(frameio_config)
        
        # Get project info
        project_id = frameio_config.get('project_id')
        if not project_id:
            print("‚ùå Project ID not configured")
            return False
        
        project = frameio_client.get_project_info(project_id)
        print(f"‚úÖ Project Frame.io: {project.get('name', 'Unknown') if project else 'Unknown'}")
        
        # Show file details
        print(f"üìä D√©tails du fichier:")
        print(f"   ‚Ä¢ Nom: {test_file.name}")
        print(f"   ‚Ä¢ Chemin: {test_file}")
        print(f"   ‚Ä¢ Taille: {test_file.stat().st_size} bytes")
        print(f"   ‚Ä¢ Existe: {test_file.exists()}")
        
        # Perform real upload
        print(f"üöÄ Upload en cours vers Frame.io...")
        
        # First, try to create a folder for PostFlow tests
        print("üìÅ Cr√©ation du dossier PostFlow_Tests...")
        folder_result = frameio_client.create_folder(
            "PostFlow_Tests",
            parent_id=project_id
        )
        
        parent_folder_id = project_id  # Default to project root
        if folder_result and folder_result.get('success'):
            parent_folder_id = folder_result.get('folder_id')
            print(f"‚úÖ Dossier cr√©√©: {parent_folder_id}")
        else:
            print(f"‚ö†Ô∏è  Utilisation de la racine du projet")
        
        # Upload the file
        upload_result = frameio_client.upload_file(
            str(test_file),
            project_id=project_id,
            parent_id=parent_folder_id,  # Use the created folder or project root
            metadata={
                "nomenclature": "UNDLM_00001",
                "scene": "REVEIL HOPITAL - JOUR",
                "version": "v999",
                "test": True,
                "workflow": "PostFlow_Real_Test"
            }
        )
        
        if upload_result and upload_result.get('success'):
            asset_id = upload_result.get('asset_id')
            frameio_url = f"https://frame.io/presentations/{project_id}/assets/{asset_id}"
            
            print(f"‚úÖ Upload r√©ussi !")
            print(f"   ‚Ä¢ Asset ID: {asset_id}")
            print(f"   ‚Ä¢ URL Frame.io: {frameio_url}")
            
            # Send success notification
            send_frameio_success_notification(test_file, frameio_url, asset_id)
            
            return frameio_url
            
        else:
            print(f"‚ùå Upload √©chou√©")
            print(f"   ‚Ä¢ R√©sultat: {upload_result}")
            
            # Try to get more details about the error
            if upload_result and 'error' in upload_result:
                print(f"   ‚Ä¢ Erreur: {upload_result['error']}")
                
            return False
        
    except Exception as e:
        print(f"‚ùå Erreur Frame.io: {e}")
        print(f"   Type: {type(e).__name__}")
        print(f"   D√©tails: {str(e)}")
        
        # Try to get more debug info
        import traceback
        print(f"   Trace: {traceback.format_exc()}")
        
        return False

def send_frameio_success_notification(test_file, frameio_url, asset_id):
    """Envoyer notification de succ√®s Frame.io"""
    try:
        # Load configuration
        config_path = Path(__file__).parent.parent / "config" / "integrations.json"
        with open(config_path, 'r') as f:
            config = json.load(f)
        
        # Initialize Discord
        discord_config = config.get('discord', {})
        discord_config_obj = DiscordConfig(
            webhook_url=discord_config['webhook_url'],
            bot_name=discord_config.get('username', 'PostFlow BOT'),
            avatar_url=discord_config.get('avatar_url', '')
        )
        discord = DiscordNotifier(discord_config_obj)
        
        # Send success notification
        embed = {
            "title": "üéâ UPLOAD FRAME.IO R√âUSSI !",
            "description": f"Le fichier **{test_file.name}** a √©t√© upload√© avec succ√®s sur Frame.io",
            "color": 0x00ff00,
            "fields": [
                {"name": "üìÅ Fichier", "value": test_file.name, "inline": True},
                {"name": "üé≠ Sc√®ne", "value": "REVEIL HOPITAL - JOUR", "inline": True},
                {"name": "üî¢ Version", "value": "v999", "inline": True},
                {"name": "üìä Taille", "value": f"{test_file.stat().st_size} bytes", "inline": True},
                {"name": "üÜî Asset ID", "value": asset_id, "inline": True},
                {"name": "üïí Upload√© √†", "value": datetime.now().strftime("%H:%M:%S"), "inline": True},
                {"name": "üîó Voir sur Frame.io", "value": f"[Cliquez ici]({frameio_url})", "inline": False},
                {"name": "üéØ Status", "value": "‚úÖ Disponible pour review", "inline": True}
            ],
            "footer": {"text": "PostFlow - Upload Frame.io R√©ussi"}
        }
        
        discord.send_message("üéâ **UPLOAD FRAME.IO R√âUSSI** - UNDLM_00001", embed)
        print("‚úÖ Notification de succ√®s envoy√©e")
        
    except Exception as e:
        print(f"‚ùå Erreur notification: {e}")

def test_discord_detection(test_file):
    """Test notification Discord de d√©tection"""
    print("\nüì¢ Test Discord Detection")
    print("-" * 30)
    
    try:
        # Load configuration
        config_path = Path(__file__).parent.parent / "config" / "integrations.json"
        with open(config_path, 'r') as f:
            config = json.load(f)
        
        # Initialize Discord
        discord_config = config.get('discord', {})
        discord_config_obj = DiscordConfig(
            webhook_url=discord_config['webhook_url'],
            bot_name=discord_config.get('username', 'PostFlow BOT'),
            avatar_url=discord_config.get('avatar_url', '')
        )
        discord = DiscordNotifier(discord_config_obj)
        
        # Send detection notification
        embed = {
            "title": "üîç FICHIER D√âTECT√â - TEST UPLOAD R√âEL",
            "description": f"**UNDLM_00001** v999 d√©tect√© - Upload Frame.io en cours",
            "color": 0x0099ff,
            "fields": [
                {"name": "üìÅ Fichier", "value": test_file.name, "inline": True},
                {"name": "üé≠ Sc√®ne", "value": "REVEIL HOPITAL - JOUR", "inline": True},
                {"name": "üî¢ Version", "value": "v999", "inline": True},
                {"name": "üìä Taille", "value": f"{test_file.stat().st_size} bytes", "inline": True},
                {"name": "üïí D√©tect√© √†", "value": datetime.now().strftime("%H:%M:%S"), "inline": True},
                {"name": "üéØ Status", "value": "‚è≥ Upload en cours...", "inline": True}
            ],
            "footer": {"text": "PostFlow - Test Upload R√©el"}
        }
        
        discord.send_message("üîç **FICHIER D√âTECT√â** - Test Upload R√©el", embed)
        print("‚úÖ Notification de d√©tection envoy√©e")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur Discord: {e}")
        return False

def main():
    """Test complet avec upload r√©el"""
    print("üé¨ " + "=" * 60)
    print("   TEST UPLOAD R√âEL FRAME.IO")
    print("   PostFlow Workflow Complet")
    print("=" * 62)
    
    start_time = time.time()
    
    # √âtape 1: Cr√©er fichier de test
    print("\nüìã √âtape 1: Cr√©ation du fichier de test")
    test_file = create_test_file()
    if not test_file:
        print("‚ùå Impossible de cr√©er le fichier de test")
        return
    
    # √âtape 2: Notification Discord de d√©tection
    print("\nüìã √âtape 2: Notification Discord de d√©tection")
    if not test_discord_detection(test_file):
        print("‚ùå Notification Discord √©chou√©e")
        return
    
    # D√©lai pour voir la notification
    print("\n‚è±Ô∏è  Attente 3 secondes...")
    time.sleep(3)
    
    # √âtape 3: Upload r√©el sur Frame.io
    print("\nüìã √âtape 3: Upload r√©el Frame.io")
    frameio_url = test_frameio_real_upload(test_file)
    
    if frameio_url:
        print(f"\nüéâ SUCC√àS ! Le fichier est maintenant visible sur Frame.io")
        print(f"üîó URL: {frameio_url}")
        
        # √âtape 4: Attendre un peu puis nettoyer
        print("\n‚è±Ô∏è  Attente 5 secondes pour que le fichier soit trait√©...")
        time.sleep(5)
        
        # Nettoyage
        print("\nüìã Nettoyage")
        try:
            if test_file.exists():
                test_file.unlink()
                print(f"‚úÖ Fichier de test supprim√©: {test_file}")
        except Exception as e:
            print(f"‚ö†Ô∏è  Erreur nettoyage: {e}")
        
        # R√©sum√© final
        end_time = time.time()
        duration = end_time - start_time
        
        print("\n" + "=" * 62)
        print("üéâ UPLOAD R√âEL R√âUSSI !")
        print("=" * 62)
        print(f"‚è±Ô∏è  Dur√©e totale: {duration:.1f} secondes")
        print(f"üîó Fichier visible sur: {frameio_url}")
        print("üì± V√©rifiez Discord pour les notifications")
        print("üåê V√©rifiez Frame.io pour voir le fichier")
        
    else:
        print(f"\n‚ùå L'upload a √©chou√© - le fichier n'est pas visible sur Frame.io")
        print("üîß V√©rifiez:")
        print("   ‚Ä¢ Les permissions du token API Frame.io")
        print("   ‚Ä¢ La configuration du projet")
        print("   ‚Ä¢ Les logs d'erreur ci-dessus")

if __name__ == "__main__":
    main()
